---
title: "Shiny Instacart"
output: 
  flexdashboard::flex_dashboard:
    orientation: row
  runtime: shiny
---


```{r setup, include=FALSE}


library(flexdashboard)
library(tidyverse)
library(janitor)
library(stringr)
library(forcats)
library(viridis)
library(plotly)
library(magrittr)
library(readr)
library(scales)
library(shiny)

```



```{r import_data}

instacart = read_csv("./data/instacart_train_data.csv.zip") %>%
  clean_names() %>%
  distinct()

```


Column {.sidebar}
-----------------------------------------------------------------------
This `flexdashboard` with Shiny was made for Homework 6 of [Jeff Goldsmith's Data Science I class](http://jeffgoldsmith.com/DSI/homework_6.html) in the Department of Biostatistics at Columbia University. This was created by [Angel Garcia de la Garza](https://github.com/angelgar) and [Soohyun Kim](https://github.com/sk4382)

The data come from the [Instacart Dataset](http://jeffgoldsmith.com/DSI/dataset_instacart.html), which contains observations of 131,209 unique users with 1,384,617 rows in which each row is a product within an order.

```{r}

departments = instacart %>%
                distinct(department) %>%
                pull()

# selectInput widget
selectInput("department_choice", label = h3("Select Department"),
            choices = departments, selected = "produce")

## sliderInput widget
min_hour = instacart %>% distinct(order_hour_of_day) %>% min()
max_hour = instacart %>% distinct(order_hour_of_day) %>% max()
  
sliderInput("time_day", label = h3("Choose hour of the day"), min = min_hour, 
        max = max_hour, value = c(10, 17), step = 1)


```

Row {.tabset .tabset-fade } 
-----------------------------------------------------------------------

### Top 15 most common items in each department

```{r}

renderPlotly({
  
barplot_product <- instacart %>%
                    filter(department == input$department_choice, 
                           order_hour_of_day <= input$time_day[2],
                           order_hour_of_day >= input$time_day[1]) %>%
                    count(product_name) %>%
                    top_n(15, n) %>%
                    mutate(product_name = fct_reorder(product_name, n)) %>%
                    ggplot(aes(x = product_name, y = n, fill = product_name)) +
                      geom_bar(stat = "identity") + 
                      theme(axis.text.x = element_text(angle = 90, hjust = 1))

ggplotly(barplot_product)

})

```


### Neighborhood popularity

```{r}

x <- list(
  title = "",
  tickangle = 40,
  tickfont = list(
    size = 8  
  )
)

y <- list(
  title = "number of listings"
)


renderPlotly({
  airbnb_data %>% 
        filter(boro == input$boro_choice, 
           price %in% input$price_range[1]:input$price_range[2],
           room_type == input$room_choice) %>%
    count(neighbourhood) %>% 
    mutate(neighbourhood = fct_reorder(neighbourhood, n)) %>% 
    plot_ly(x = ~neighbourhood, y = ~n, color = ~neighbourhood, type = "bar") %>%
      layout(xaxis = x, yaxis = y)
})
```

### Prices for most popular neighborhoods

```{r}
renderPlotly({ 
  common_neighborhoods =
    airbnb_data %>% 
    filter(boro == input$boro_choice,
           price %in% input$price_range[1]:input$price_range[2],
           room_type == input$room_choice) %>%
    count(neighbourhood, sort = TRUE) %>% 
    top_n(8) %>% 
    select(neighbourhood)

  airbnb_data %>%
    filter(boro == input$boro_choice,
                          price %in% input$price_range[1]:input$price_range[2],
                          room_type == input$room_choice) %>%
    inner_join(., common_neighborhoods, by = "neighbourhood") %>% 
    plot_ly(y = ~price, color = ~neighbourhood, type = "box",
          colors = "Set2") %>%
    layout(xaxis = x)
  
})

```

